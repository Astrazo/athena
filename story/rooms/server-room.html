<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athena</title>
    <link rel="stylesheet" href="../../src/styles/styles.css">
    <link rel="icon" href="data:,">
    
    <!-- Firebase CDN - Load in head to ensure it's available -->
    <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <button id="back" class="back-button">‚Üê Back to Situation Room</button>
    <!-- Game Info Display -->
    <div id="gameInfo" class="game-info game-panel">
        <div id="roomName">Room: Loading...</div>
        <div id="currentDay">Day: Loading...</div>
        <div id="playerCount">Players: Loading...</div>
        <div id="yourName">You: Loading...</div>
        <div id="playerList" class="player-list">
            <h3>Team Composition</h3>
            <ul id="players"></ul>
        </div>
    </div>

    <div class="menu-container">
        <h1 id="lobbyHeader">Server Room</h1>
        <!--<h2 id="lobbySubheader">Pick a room to explore</h2>-->
        <div id="availableActions" class="button-container">
           
        </div>
    </div>
    <div id="loadingContainer" class="loading-container" style="display: none;">
        <div class="loading-spinner"></div>
        <div id="loadingMessage" class="loading-message">Loading...</div>
    </div>
    
    <!-- Objective Display -->
    <div id="objectiveDisplay" class="objective-display game-panel">
        <h3>Objective</h3>
        <p>Loading objective...</p>
    </div>

    <script type="module">
        // Wait for Firebase to be fully loaded
        function waitForFirebase() {
            return new Promise((resolve) => {
                if (window.firebase && window.firebase.firestore) {
                    resolve();
                } else {
                    // Check every 100ms for Firebase to be ready
                    const interval = setInterval(() => {
                        if (window.firebase && window.firebase.firestore) {
                            clearInterval(interval);
                            resolve();
                        }
                    }, 100);
                }
            });
        }
        
        // Wait for Firebase, then import and run
        waitForFirebase().then(async () => {
            const { updatePlayer, listenToRoom, generateActions, updateRoleList, navigateToRoom } = await import("../../src/js/main.js");
            const TypewriterDialogue = await import("../../src/js/typewriter.js");
            const { dialogue } = await import("../../src/js/dialogue.js");
            const { roomActions } = await import("../../src/js/room-actions.js");
            const { setCurrentObjective, updateObjective } = await import("../../src/js/objectives.js");
            const { enablerMap } = await import("../../src/js/enabler-map.js");
            const toast = await import("../../src/js/toast.js");

            // Get room data from localStorage
            const roomId = localStorage.getItem("connectedRoomId");
            const localUserId = localStorage.getItem("connectedUserId");
            const roomName = localStorage.getItem("connectedRoomName");
            const username = localStorage.getItem("connectedUsername");
            const userRole = localStorage.getItem("connectedUserRole");
            let enablerComplete = null;
            let enabledComplete = null;
            let enabledPossible = null;
            let currentDay = 0;
            let previousEnabledValue = null;

            // Local, global, trackers 
            let isInitialLoad = true;
            let currentRoomData = null;
            
            // Setup back button
            document.getElementById("back").addEventListener("click", () => {
                navigateToRoom("Situation Room")
            });
            // Function to update game info
            function updateGameInfo(roomData) {
                if (roomData) {
                    // Update general room info
                    document.getElementById("roomName").textContent = `Room: ${roomData["roomName"]}`;
                    document.getElementById("currentDay").textContent = `Day: ${roomData["currentDay"]}`;
                    const playersArray = roomData["roomPlayers"] ? Object.values(roomData["roomPlayers"]) : [];
                    document.getElementById("playerCount").textContent = `Players: ${playersArray.length}/4`;
                    document.getElementById("yourName").textContent = "";

                    // Figure out what puzzle status the player has 
                    enablerComplete = roomData["roomPlayers"][localUserId]["enablerComplete"];
                    enabledComplete = roomData["roomPlayers"][localUserId]["enabledComplete"];
                    const currentEnabledValue = roomData["roomPlayers"][localUserId]["enabledValue"];

                    // Can they complete the enabled puzzle yet?
                    enabledPossible = currentEnabledValue != null;
                     
                    // Grab current day
                    currentDay = roomData["currentDay"];

                    // Check if enabledValue just changed from null to a value
                    if (currentEnabledValue !== null && currentEnabledValue != previousEnabledValue) {
                        // Only show toast if we haven't shown it for this enabledValue
                        if (!localStorage.getItem('enabledValueToastShown')) {
                            showEnabledValueToast().catch(error => {
                                console.warn('Error showing enabled value toast:', error);
                            });
                            localStorage.setItem('enabledValueToastShown', 'true');
                        }
                    }

                    // Clear the flag when enabledValue goes back to null (new day)
                    if (currentEnabledValue === null && previousEnabledValue !== null) {
                        localStorage.removeItem('enabledValueToastShown');
                    }

                    // Update previous value for next comparison
                    previousEnabledValue = currentEnabledValue;
                }
            }

            // Function to show toast when enabledValue is received
            async function showEnabledValueToast() {
                console.log('showEnabledValueToast called');
                const roleNames = {
                    "ds": "Data Scientist",
                    "se": "Software Engineer", 
                    "ne": "Network Engineer",
                    "ca": "Cybersecurity Analyst"
                };

                // Get who enabled this player based on enabler map
                const enablerRole = enablerMap[currentDay][userRole];
                const enablerName = roleNames[enablerRole];

                toast.success(`The ${enablerName} has sent you some information to be used in another room.`);
                
                // Play notification sound when receiving enabled value
                try {
                    console.log('Importing audio module...');
                    const { playNotification } = await import("../../src/js/audio.js");
                    console.log('Audio module imported, playing notification...');
                    playNotification();
                } catch (error) {
                    console.warn('Audio not available:', error);
                }
                
                // Check if player is in the correct room for their enabled puzzle
                if (isInEnabledPuzzleRoom()) {
                    // Trigger dialogue for enabled puzzle
                    triggerEnabledDialogue();
                }
            }

            // Function to determine if player is in the room where their enabled puzzle is located
            function isInEnabledPuzzleRoom() {
                const enabledPuzzleRoom = getEnabledPuzzleRoom();
                return enabledPuzzleRoom === "server-room";
            }

            // Function to get the room where the player's enabled puzzle is located
            function getEnabledPuzzleRoom() {
                const enabledPuzzleRooms = {
                    1: {
                        "ca": "research-lab",
                        "ne": "developer-hub", 
                        "se": "server-room",
                        "ds": "command-centre"
                    },
                    2: {
                        "ca": "command-centre",
                        "ne": "server-room",
                        "se": "research-lab", 
                        "ds": "command-centre"
                    },
                    3: {
                        "ca": "command-centre",
                        "ne": "server-room",
                        "se": "developer-hub",
                        "ds": "research-lab"
                    }
                };
                
                return enabledPuzzleRooms[currentDay]?.[userRole] || null;
            }

            // Function to trigger dialogue for enabled puzzle
            function triggerEnabledDialogue() {
                const dialogueToShow = dialogue?.[currentDay]?.[userRole]?.["server-room"];
                
                if (dialogueToShow && dialogueToShow["enabled"]) {
                    typewriter.showSequence(dialogueToShow["enabled"]);
                }
            }

            // 
            function handleDialogue() {
                if (isInitialLoad) {
                    // First, see if for this day, this role is supposed to be in this room
                    const dialogueToShow = dialogue?.[currentDay]?.[userRole]?.["server-room"] || null;

                    // If nothing has been returned, that means the user is in the wrong room
                    if (dialogueToShow === null) {
                        typewriter.showSequence(dialogue["WRONG-ROOM"]);
                    }
                    // Otherwise, show the dialogue
                    else {
                        // If the user has an enabler task in here
                        if (dialogueToShow["enabler"]) {
                            // Has it been completed already?
                            if (!enablerComplete) {
                                typewriter.showSequence(dialogueToShow["enabler"]);
                            }
                            else {
                                // For enabler-complete, check if both tasks are done
                                const baseDialogue = dialogueToShow["enabler-complete"].slice(0, -1); // Remove the last line
                                const completionMessage = getCompletionMessage();
                                typewriter.showSequence([...baseDialogue, completionMessage]);
                            }
                        }
                        else if (dialogueToShow["enabled"]) {
                            if (enabledPossible && !enabledComplete){
                                typewriter.showSequence(dialogueToShow["enabled"])
                            }
                            else if (enabledComplete) {
                                // For enabled-complete, check if both tasks are done
                                const baseDialogue = dialogueToShow["enabled-complete"].slice(0, -1); // Remove the last line
                                const completionMessage = getCompletionMessage();
                                typewriter.showSequence([...baseDialogue, completionMessage]);
                            }
                            else {
                                typewriter.showSequence(dialogueToShow["enabled-not-available"])
                            }
                        }
                    }

                    isInitialLoad = false;
                }
            }

            // Helper function to determine the correct completion message
            function getCompletionMessage() {
                if (enabledComplete && enablerComplete) {
                    // Update objective immediately when both tasks are complete
                    setCurrentObjective("Objective", "Return to situation room and wait.");
                    return "You feel like you've done all you can for today, return to the situation room and wait for your teammates to finish up.";
                } else {
                    setCurrentObjective("Objective", "Explore other rooms.");
                    return "You should investigate some other rooms in case you can assist further.";
                }
            }

            // Set up real-time listener for game info updates
            const unsubscribe = listenToRoom(roomId, (roomData) => {
                if (roomData) {
                    console.log("Room updated.")
                    currentRoomData = roomData;
                    updateGameInfo(roomData);
                    updateRoleList(roomData, document.getElementById("players"));
                    
                    // Always update the objective when room data changes
                    setCurrentObjective("server-room", roomData, localStorage.getItem("connectedUserRole"));

                    // Only run this stuff it it's in the initiload load
                    if (isInitialLoad) {
                        // Load in actions this role can do during this run
                        generateActions(
                            roomData, 
                            "server-room", 
                            localStorage.getItem("connectedUserRole"), 
                            document.getElementById("availableActions")
                        );

                        // Show dialogue
                        handleDialogue();

                        isInitialLoad = false;
                    }
                } else {
                    console.error("Room not found");
                    window.location.href = "../index.html";
                }
            });

            // Initial update with stored data
            //updateGameInfo({ roomName: roomName, roomPlayers: roomData.roomPlayers });

            // Show welcome dialogue when page loads
            /*document.addEventListener('DOMContentLoaded', () => {
                typewriter.showSequence([
                    "Welcome to the situation room.",
                    "Please pick a room to explore."
                ], {
                    speed: 40
                });
            });*/

            // Start game button listener
            /*document.getElementById("startGameBtn").addEventListener("click", () => {
                typewriter.show("Initiating mission sequence...", {
                    onComplete: () => {
                        setTimeout(() => {
                            // Here you would redirect to the first puzzle/room
                            // For now, we'll just show a placeholder message
                            typewriter.show("Mission sequence initiated. First puzzle loading...", {
                                onComplete: () => {
                                    // Placeholder - replace with actual puzzle page
                                    alert("Puzzle system coming soon!");
                                }
                            });
                        }, 1000);
                    }
                });
            });*/

            // Clean up listener when leaving the page
            window.addEventListener("beforeunload", () => {
                if (unsubscribe) {
                    unsubscribe();
                }
            });
        });
    </script>
</body>
</html>

