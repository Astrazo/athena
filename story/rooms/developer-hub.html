<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athena</title>
    <link rel="stylesheet" href="/styles.css">

</head>
<body>
    <button class="back-button" onclick="window.location.href='../situation-room'">‚Üê Back</button>
    <!-- Game Info Display -->
    <div id="gameInfo" class="game-info">
        <div id="roomName">Room: Loading...</div>
        <div id="playerCount">Players: Loading...</div>
        <div id="yourName">You: Loading...</div>
        <div id="playerList" class="player-list">
            <h3>Team Composition</h3>
            <ul id="players"></ul>
        </div>
    </div>

    <div class="menu-container">
        <h1 id="lobbyHeader">Developer Hub</h1>
        <!--<h2 id="lobbySubheader">Pick a room to explore</h2>-->
        <div class="button-container">
            <button id="serverBtn" class="std-button role-button" style="width: 250px; max-width: 100%;" onclick="window.location.href='server-room.html'">Server Room</button>
            <button id="researchBtn" class="std-button role-button" style="width: 250px;" onclick="window.location.href='research-lab.html'">Research Lab</button>
            <button id="commandBtn" class="std-button role-button" style="width: 250px; max-width: 100%;" onclick="window.location.href='command-centre.html'">Command Centre</button>
            <button id="developerBtn" class="std-button role-button" style="width: 250px;" onclick="window.location.href='developer-hub.html'">Developer Hub</button>
        </div>
    </div>

    <script type="module">
        import { updatePlayer, listenToRoom } from "/main.js";
        import TypewriterDialogue from "/typewriter.js";
        import { dialogue } from "/dialogue.js";

        // Get room data from localStorage
        const roomId = localStorage.getItem("connectedRoomId");
        const localUserId = localStorage.getItem("connectedUserId");
        const roomName = localStorage.getItem("connectedRoomName");
        const username = localStorage.getItem("connectedUsername");
        const userRole = localStorage.getItem("connectedUserRole");
        let enablerComplete = null;
        let enabledComplete = null;
        let canDoEnabled = null;
        let currentDay = 0;

        // Local, global, trackers 
        let isInitialLoad = true;
        let currentRoomData = null;

        // Function to update game info
        function updateGameInfo(roomData) {
            if (roomData) {
                // Update general room info
                document.getElementById("roomName").textContent = `Room: ${roomData["roomName"]}`;
                const playersArray = roomData["roomPlayers"] ? Object.values(roomData["roomPlayers"]) : [];
                document.getElementById("playerCount").textContent = `Players: ${playersArray.length}/4`;
                document.getElementById("yourName").textContent = `You: ${username}`;

                // Figure out what puzzle status the player has 
                enablerComplete = currentRoomData["roomPlayers"][localUserId]["enablerComplete"];
                enabledComplete = currentRoomData["roomPlayers"][localUserId]["enabledComplete"];

                // Can they complete the enabled puzzle yet?
                canDoEnabled = currentRoomData["roomPlayers"][localUserId]["enabledValue"] != null;
                 
                // Grab current day
                currentDay = currentRoomData["currentDay"];

            }
        }
        function updateRoleList(roomData) {
            // Update role list
            const playersList = document.getElementById("players");
            playersList.innerHTML = "";
            
            if (roomData && roomData["roomPlayers"]) {
                // Display player list
                Object.entries(roomData["roomPlayers"]).forEach(([playerId, player]) => {
                    const li = document.createElement("li");
                    const roleNames = {
                        "ds": "Data Scientist",
                        "se": "Software Engineer",
                        "ne": "Network Engineer",
                        "ca": "Cybersecurity Analyst"
                    };
                    const roleName = roleNames[player["role"]] || "Unassigned";
                    li.textContent = `${player["name"]} - ${roleName}`;
                    if (playerId === localUserId) {
                        li.classList.add("current-player");
                        li.style.fontWeight = "bold";
                        li.style.color = "#4CAF50";
                    }
                    playersList.appendChild(li);
                });
            }
        }

        // 
        function handleDialogue(roomData) {
            // First, see if for this day, this role is supposed to be in this room
            const dialogueToShow = dialogue?.[currentDay]?.[userRole]?.["developer-hub"] || null;

            // If nothing has been returned, that means the user is in the wrong room
            if (dialogueToShow === null) {
                typewriter.showSequence(dialogue["wrong-room"]);
            }
            // Otherwise, show the dialogue
            else {
                // If the user has an enabler task in here
                if (dialogueToShow["enabler"]) {
                    // Has it been completed already?
                    if (!enablerComplete) {
                        typewriter.showSequence(dialogueToShow["enabler"]);
                    }
                    else {
                        typewriter.showSequence(dialogueToShow["enabler-complete"]);
                    }
                }
                else if (dialogueToShow["enabled"]) {
                    if (canDoEnabled && !enabledComplete){
                        typewriter.showSequence(dialogueToShow["enabled"])
                    }
                    else if (enabledComplete) {
                        typewriter.showSequence(dialogueToShow["enabled-complete"])
                    }
                    else {
                        typewriter.showSequence(dialogueToShow["enabled-not-available"])
                    }
                }
            }
        }

        // Set up real-time listener for game info updates
        const unsubscribe = listenToRoom(roomId, (roomData) => {
            if (roomData) {
                console.log("Room updated.")
                currentRoomData = roomData;
                updateGameInfo(roomData);
                updateRoleList(roomData);
                handleDialogue();

                /*if (isInitialLoad) {
                    handleDialogue(roomData)
                    isInitialLoad = false
                }
                else if (isRoleReassignmentLoad) {
                    handleRoleReasignmentDialogue(roomData)
                    isRoleReassignmentLoad = false;
                }*/
            } else {
                console.error("Room not found");
                window.location.href = "../index.html";
            }
        });

        // Initial update with stored data
        //updateGameInfo({ roomName: roomName, roomPlayers: roomData.roomPlayers });

        // Show welcome dialogue when page loads
        /*document.addEventListener('DOMContentLoaded', () => {
            typewriter.showSequence([
                "Welcome to the situation room.",
                "Please pick a room to explore."
            ], {
                speed: 40
            });
        });*/

        // Start game button listener
        /*document.getElementById("startGameBtn").addEventListener("click", () => {
            typewriter.show("Initiating mission sequence...", {
                onComplete: () => {
                    setTimeout(() => {
                        // Here you would redirect to the first puzzle/room
                        // For now, we'll just show a placeholder message
                        typewriter.show("Mission sequence initiated. First puzzle loading...", {
                            onComplete: () => {
                                // Placeholder - replace with actual puzzle page
                                alert("Puzzle system coming soon!");
                            }
                        });
                    }, 1000);
                }
            });
        });*/

        // Clean up listener when leaving the page
        window.addEventListener("beforeunload", () => {
            if (unsubscribe) {
                unsubscribe();
            }
        });
    </script>
</body>
</html>

