<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athena</title>
    <link rel="stylesheet" href="../styles.css">

</head>
<body>
    <!-- Game Info Display -->
    <div id="gameInfo" class="game-info">
        <div id="roomName">Room: Loading...</div>
        <div id="playerCount">Players: Loading...</div>
        <div id="yourName">You: Loading...</div>
    </div>

    <div class="menu-container">
        <h1 id="lobbyHeader">Team Assembly Complete</h1>
        <div id="playerList" class="player-list">
            <h3>Team Composition</h3>
            <ul id="players"></ul>
        </div>
    </div>

    <script type="module">
        import { updatePlayer, listenToRoom } from "../main.js";
        import TypewriterDialogue from "../typewriter.js";

        // Get room data from localStorage
        const roomId = localStorage.getItem("connectedRoomId");
        const localUserId = localStorage.getItem("connectedUserId");
        const roomName = localStorage.getItem("connectedRoomName");
        const username = localStorage.getItem("connectedUsername");
        //const roomData = JSON.parse(localStorage.getItem("roomData") || "{}");

        // Check for duplicate roles
        let hasDuplicateRoles = false;
        const rolesPicked = {
            "ds": {"count": 0, "users": []},
            "se": {"count": 0, "users": []},
            "ne": {"count": 0, "users": []},
            "ca": {"count": 0, "users": []}
        }
        
        // Local, global, trackers 
        let isInitialLoad = true;
        let isRoleReassignmentLoad = false;
        let currentRoomData = null;

        // Function to update game info
        function updateGameInfo(roomData) {
            if (roomData) {
                // Update general room info
                document.getElementById("roomName").textContent = `Room: ${roomData["roomName"]}`;
                const playersArray = roomData["roomPlayers"] ? Object.values(roomData["roomPlayers"]) : [];
                document.getElementById("playerCount").textContent = `Players: ${playersArray.length}/4`;
                document.getElementById("yourName").textContent = `You: ${username}`;
            }
        }

        function updateRoleList(roomData) {
            // Update role list
            const playersList = document.getElementById("players");
            playersList.innerHTML = "";
            
            if (roomData && roomData["roomPlayers"]) {
                // Display player list
                Object.entries(roomData["roomPlayers"]).forEach(([playerId, player]) => {
                    const li = document.createElement("li");
                    const roleNames = {
                        'ds': 'Data Scientist',
                        'se': 'Software Engineer',
                        'ne': 'Network Engineer',
                        'ca': 'Cybersecurity Analyst'
                    };
                    const roleName = roleNames[player["role"]] || 'Unassigned';
                    li.textContent = `${player["name"]} - ${roleName}`;
                    if (playerId === localUserId) {
                        li.classList.add("current-player");
                        li.style.fontWeight = "bold";
                        li.style.color = "#4CAF50";
                        // Set the role to local storage for easy reference later
                        localStorage.setItem("connectedUserRole", player["role"])
                    }
                    playersList.appendChild(li);
                });
                
                // Check for duplicates
                Object.entries(roomData["roomPlayers"]).forEach(([playerId, player]) => {
                    const role = player["role"];
                    if (role && role !== "None") {
                        rolesPicked[role]["count"] = (rolesPicked[role]["count"] || 0) + 1;
                        rolesPicked[role]["users"].push(playerId);
                        if (rolesPicked[role]["count"] > 1) {
                            hasDuplicateRoles = true;
                        }
                    }
                });
            }
        }

        function handleDialogue(roomData) {
            if (hasDuplicateRoles) {
                typewriter.showSequence([
                    "You picked the same roles?!?!",
                    "I thought you were the best?",
                    "I guess I'll have to handle you myself..."
                ], 
                {
                    speed: 40,
                    onComplete: () => {
                        // Remove the dialoge box
                        typewriter.hide()

                        // Set to true for all clients so the correct dialogue will play for all on reload
                        isRoleReassignmentLoad = true;

                        // Host client will now randomise the roles to players who duplicate their selection
                        if (roomData["roomPlayers"][localUserId]["isHost"] === "1") {
                            Object.entries(rolesPicked).forEach(([roleId, data]) => {
                                console.log(rolesPicked)
                                if (data["count"] > 1) {
                                    // Get available roles (roles that haven't been selected)
                                    const availableRoles = Object.keys(rolesPicked).filter(role => rolesPicked[role]["count"] === 0);
                                    
                                    // Grab the users who picked this role
                                    const duplicateUsers = data.users.slice(1); // Skip first user who keeps their choice
                                    
                                    // Distribute available roles to the duplicate users
                                    duplicateUsers.forEach((userId, index) => {
                                        if (availableRoles.length > 0) {
                                            // Randomly select an available role
                                            const randomIndex = Math.floor(Math.random() * availableRoles.length);
                                            const newRole = availableRoles.splice(randomIndex, 1)[0];
                                            // Update the player's role in the database
                                            updatePlayer(userId, roomId, "role", newRole);
                                        }
                                    });
                                }
                            })
                        }
                    }
                }); 
            }
            else {
                typewriter.showSequence([
                    "Good work team",
                    "Lets get to work!"
                ], 
                {
                    speed: 40, 
                    onContinue: () => {window.location.href = "situation-room.html"}
                }); 
            }
        }

        function handleRoleReasignmentDialogue(roomData) {
            typewriter.showSequence([
                    "Now that that's sorted, lets get to work.",
                    "Your communication skills can surely only get better from here.",
                    "Right?"
                ], 
                {speed: 40});    
        }

        // Set up real-time listener for game info updates
        const unsubscribe = listenToRoom(roomId, (roomData) => {
            if (roomData) {
                currentRoomData = roomData;
                updateGameInfo(roomData);
                updateRoleList(roomData);

                if (isInitialLoad) {
                    handleDialogue(roomData)
                    isInitialLoad = false
                }
                else if (isRoleReassignmentLoad) {
                    handleRoleReasignmentDialogue(roomData)
                    isRoleReassignmentLoad = false;
                }
            } else {
                console.error("Room not found");
                window.location.href = "../index.html";
            }
        });

        // Initial update with stored data
        //updateGameInfo({ roomName: roomName, roomPlayers: roomData.roomPlayers });

        // Show welcome dialogue when page loads
        /*document.addEventListener('DOMContentLoaded', () => {
            typewriter.showSequence([
                "Team assembly complete. All roles have been assigned.",
                "Your specialized skills will be essential for the challenges ahead.",
                "The digital escape room awaits your expertise.",
                "Are you ready to begin the mission?"
            ], {
                speed: 40
            });
            console.log(hasDuplicateRoles)
        });*/

        // Start game button listener
        /*document.getElementById("startGameBtn").addEventListener("click", () => {
            typewriter.show("Initiating mission sequence...", {
                onComplete: () => {
                    setTimeout(() => {
                        // Here you would redirect to the first puzzle/room
                        // For now, we'll just show a placeholder message
                        typewriter.show("Mission sequence initiated. First puzzle loading...", {
                            onComplete: () => {
                                // Placeholder - replace with actual puzzle page
                                alert("Puzzle system coming soon!");
                            }
                        });
                    }, 1000);
                }
            });
        });*/

        // Clean up listener when leaving the page
        window.addEventListener("beforeunload", () => {
            if (unsubscribe) {
                unsubscribe();
            }
        });
    </script>
</body>
</html>

