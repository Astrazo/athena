<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athena</title>
    <link rel="stylesheet" href="../styles.css">

</head>
<body>
    <!-- Game Info Display -->
    <div id="gameInfo" class="game-info">
        <div id="roomName">Room: Loading...</div>
        <div id="playerCount">Players: Loading...</div>
        <div id="yourName">You: Loading...</div>
    </div>

    <div class="menu-container">
        <h1 id="lobbyHeader">Team Assembly Complete</h1>
        <div id="roomInfo" class="room-info">
            <h2 id="roomName">Finalise Roles</h2>
        </div>

        <div id="playerList" class="player-list">
            <h3>Team Composition</h3>
            <ul id="players"></ul>
        </div>

        <div class="button-container">
            <button id="startGameBtn" class="std-button" style="width: 300px; font-size: 18px; padding: 15px;">Begin Mission</button>
        </div>
    </div>

    <script type="module">
        import { updatePlayer, listenToRoom } from "../main.js";
        import TypewriterDialogue from "../typewriter.js";

        // Get room data from localStorage
        const roomId = localStorage.getItem("connectedRoomId");
        const userId = localStorage.getItem("connectedUserId");
        const roomName = localStorage.getItem("connectedRoomName");
        const username = localStorage.getItem("connectedUsername");
        const roomData = JSON.parse(localStorage.getItem("roomData") || "{}");

        // Function to update game info
        function updateGameInfo(roomData) {
            if (roomData) {

                // Update general room info
                document.getElementById("roomName").textContent = `Room: ${roomData.roomName}`;
                const playersArray = roomData["roomPlayers"] ? Object.values(roomData["roomPlayers"]) : [];
                document.getElementById("playerCount").textContent = `Players: ${playersArray.length}/4`;
                document.getElementById("yourName").textContent = `You: ${username}`;

                // Update role list
                const playersList = document.getElementById("players");
                playersList.innerHTML = "";
                if (roomData && roomData.roomPlayers) {
                    Object.entries(roomData.roomPlayers).forEach(([playerId, player]) => {
                        const li = document.createElement("li");
                        const roleNames = {
                            'ds': 'Data Scientist',
                            'se': 'Software Engineer',
                            'ne': 'Network Engineer',
                            'ca': 'Cybersecurity Analyst'
                        };
                        const roleName = roleNames[player.role] || 'Unassigned';
                        li.textContent = `${player.name} - ${roleName}`;
                        if (playerId === userId) {
                            li.classList.add("current-player");
                            li.style.fontWeight = "bold";
                            li.style.color = "#4CAF50";
                        }
                        playersList.appendChild(li);
                    });
                }        
            }
        }

        // Set up real-time listener for game info updates
        const unsubscribe = listenToRoom(roomId, (roomData) => {
            if (roomData) {
                updateGameInfo(roomData);
            } else {
                console.error("Room not found");
                window.location.href = "../index.html";
            }
        });

        // Initial update with stored data
        //updateGameInfo({ roomName: roomName, roomPlayers: roomData.roomPlayers });

        // Show welcome dialogue when page loads
        document.addEventListener('DOMContentLoaded', () => {
            typewriter.showSequence([
                "Team assembly complete. All roles have been assigned.",
                "Your specialized skills will be essential for the challenges ahead.",
                "The digital escape room awaits your expertise.",
                "Are you ready to begin the mission?"
            ], {
                speed: 40
            });
        });

        // Start game button listener
        document.getElementById("startGameBtn").addEventListener("click", () => {
            typewriter.show("Initiating mission sequence...", {
                onComplete: () => {
                    setTimeout(() => {
                        // Here you would redirect to the first puzzle/room
                        // For now, we'll just show a placeholder message
                        typewriter.show("Mission sequence initiated. First puzzle loading...", {
                            onComplete: () => {
                                // Placeholder - replace with actual puzzle page
                                alert("Puzzle system coming soon!");
                            }
                        });
                    }, 1000);
                }
            });
        });

        // Clean up listener when leaving the page
        window.addEventListener("beforeunload", () => {
            if (unsubscribe) {
                unsubscribe();
            }
        });
    </script>
</body>
</html>

