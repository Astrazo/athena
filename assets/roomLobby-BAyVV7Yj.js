import{d as w,u as f,e as S,r as v,l as h}from"./main-3GqDBcTq.js";const m=localStorage.getItem("connectedRoomId"),i=localStorage.getItem("connectedUserId"),y=localStorage.getItem("connectedRoomName"),g=localStorage.getItem("connectedUsername"),c=JSON.parse(localStorage.getItem("localRoomData")||"{}");if(!m||!i||!y||!g||!c)throw console.error("Missing required data:",{roomId:m,userId:i,roomName:y,username:g,localRoomData:c}),window.location.href="index.html",new Error("Missing required data");function I(e){if(e){document.getElementById("roomName").textContent=`Room: ${e.roomName}`;const n=e.roomPlayers?Object.values(e.roomPlayers):[];document.getElementById("playerCount").textContent=`Players: ${n.length}/4`,document.getElementById("yourName").textContent=`You: ${g}`}}document.getElementById("lobbyHeader").textContent=y;const p=c.roomPlayers?Object.values(c.roomPlayers):[];document.getElementById("playerCount").textContent=`Players: ${p.length}/4`;function E(e){if(e){I(e);const n=e.roomPlayers?Object.values(e.roomPlayers):[];document.getElementById("playerCount").textContent=`Players: ${n.length}/4`;const s=document.getElementById("players");if(s.innerHTML="",e.roomPlayers){Object.entries(e.roomPlayers).forEach(([a,o])=>{const t=document.createElement("li"),d=o.readyStatus===1?"(ready)":"(not ready)";t.textContent=`${o.name} ${d}`,a===i&&t.classList.add("current-player"),s.appendChild(t)});const l=n.length>=4&&n.every(a=>a.readyStatus===1);if(l&&!window.countdownStarted){window.countdownStarted=!0;let o=5,t=document.getElementById("countdown");t||(t=document.createElement("div"),t.id="countdown",t.style.position="fixed",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.fontSize="48px",t.style.fontWeight="bold",t.style.color="#4CAF50",document.body.appendChild(t));const d=setInterval(()=>{t.textContent=`Game starting in ${o}`,o--,o<=0&&(clearInterval(d),t&&t.remove(),console.log("Game has commenced."),window.location.href="story/role-select.html")},1e3);window.countdownIntervalId=d}else if(window.countdownStarted&&!l){window.countdownStarted=!1,window.countdownIntervalId&&(clearInterval(window.countdownIntervalId),window.countdownIntervalId=null);const a=document.getElementById("countdown");a&&a.remove()}}}}const u=w(m,e=>{e?(console.log(`Room ${e.roomId} updated:`),E(e),localStorage.setItem("localRoomData",JSON.stringify(e))):(console.error("Room not found"),window.location.href="index.html")});I({roomName:y,roomPlayers:c.roomPlayers});window.addEventListener("beforeunload",()=>{u&&u()});const r=document.getElementById("readyUp");r.addEventListener("click",async()=>{try{const e=r.textContent==="Ready Up"?1:0;await f(i,m,"readyStatus",e),r.textContent==="Ready Up"?(r.textContent="Not Ready",r.classList.add("ready")):(r.textContent="Ready Up",r.classList.remove("ready")),localStorage.setItem("readyStatus",e)}catch(e){console.error("Error updating ready status:",e),alert("Failed to update ready status. Please try again.")}});document.getElementById("leaveRoom").addEventListener("click",async()=>{try{const e=localStorage.getItem("connectedUserId"),n=localStorage.getItem("connectedRoomId"),s=localStorage.getItem("connectedUsername"),l=JSON.parse(localStorage.getItem("localRoomData"));if((l.roomPlayers?Object.values(l.roomPlayers):[]).length===1)if(confirm("You are the last player in this room. Would you like to delete the room?"))await S(n),console.log(`Room ${n} deleted successfully.`);else return;await v(e,s,"None",n),localStorage.removeItem("connectedRoomId"),localStorage.removeItem("connectedUserId"),localStorage.removeItem("connectedRoomName"),localStorage.removeItem("connectedUsername"),localStorage.removeItem("readyStatus"),localStorage.removeItem("roomData"),u&&u(),document.getElementById("loadingContainer").style.display="flex";try{const o=await h(void 0,void 0,0);localStorage.setItem("availableRooms",JSON.stringify(o)),window.location.href="room-select.html"}catch(o){console.error("Error loading rooms:",o),localStorage.removeItem("availableRooms")}}catch(e){console.error("Error leaving room:",e),alert("Failed to leave room. Please try again.")}});
