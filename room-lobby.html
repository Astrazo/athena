<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Lobby - Athena</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="menu-container">
        <h1 id="lobbyHeader"></h1>
        <div id="roomInfo" class="room-info">
            <h2 id="roomName">Lobby</h2>
            <div id="playerCount">Players: 0/4</div>
        </div>

        <div id="playerList" class="player-list">
            <h3>Players</h3>
            <ul id="players"></ul>
        </div>

        <div class="button-container">
            <button id="readyUp" class="std-button" style="width: 200px; max-width: 100%; ">Ready Up</button>
            <button id="leaveRoom" class="std-button" style="width: 200px;">Leave Room</button>
        </div>
    </div>

    <script type="module">
        import { loadRooms, removeUserFromRoom, startGame, updatePlayerReadyStatus } from './main.js';

        // Get room data from localStorage
        const roomId = localStorage.getItem('connectedRoomId');
        const userId = localStorage.getItem('connectedUserId');
        const roomName = localStorage.getItem('connectedRoomName');
        const username = localStorage.getItem('connectedUsername');
        const roomData = JSON.parse(localStorage.getItem('roomData') || '{}');

        // Check if we have all required data
        if (!roomId || !userId || !roomName || !username || !roomData) {
            console.error('Missing required data:', { roomId, userId, roomName, username, roomData });
            window.location.href = 'index.html';
            throw new Error('Missing required data');
        }

        // Update room info
        document.getElementById('lobbyHeader').textContent = roomName;
        document.getElementById('playerCount').textContent = `Players: ${roomData.roomPlayers?.length || 0}/4`;

        // Function to update room data
        async function updateRoomData() {
            try {
                const updatedRoom = await loadRooms(null, localStorage.getItem('connectedRoomId'));
                if (updatedRoom) {
                    // Update player count
                    document.getElementById('playerCount').textContent = `Players: ${updatedRoom.roomPlayers?.length || 0}/4`;
                    
                    // Update player list
                    const playersList = document.getElementById('players');
                    playersList.innerHTML = ''; // Clear current list
                    if (updatedRoom.roomPlayers) {
                        updatedRoom.roomPlayers.forEach(player => {
                            const li = document.createElement('li');
                            const readyStatus = player.readyStatus === '1' ? '(ready)' : '(not ready)';
                            li.textContent = `${player.name} ${readyStatus}${player.id === userId ? ' (you)' : ''}`;
                            if (player.id === userId) {
                                li.classList.add('current-player');
                            }
                            playersList.appendChild(li);
                        });

                        // Check if there's 4 players, and they're all ready
                        const allReady = updatedRoom.roomPlayers.length === 4 && 
                                       updatedRoom.roomPlayers.every(player => player.readyStatus === '1');
                        
                        if (allReady && !window.countdownStarted) {
                            window.countdownStarted = true;
                            let countdown = 5;
                            
                            // Create countdown element if it doesn't exist
                            let countdownElement = document.getElementById('countdown');
                            if (!countdownElement) {
                                countdownElement = document.createElement('div');
                                countdownElement.id = 'countdown';
                                countdownElement.style.position = 'fixed';
                                countdownElement.style.top = '50%';
                                countdownElement.style.left = '50%';
                                countdownElement.style.transform = 'translate(-50%, -50%)';
                                countdownElement.style.fontSize = '48px';
                                countdownElement.style.fontWeight = 'bold';
                                countdownElement.style.color = '#4CAF50';
                                document.body.appendChild(countdownElement);
                            }

                            // Start countdown
                            const countdownInterval = setInterval(() => {
                                countdownElement.textContent = countdown;
                                countdown--;

                                if (countdown < 0) {
                                    clearInterval(countdownInterval);
                                    window.location.href = 'title.html';
                                }
                            }, 1000);
                        }
                    }
                }
            } catch (error) {
                console.error('Error updating room data:', error);
            }
        }

        // Initial update
        updateRoomData();

        // Set up periodic updates
        const updateInterval = setInterval(updateRoomData, 2000);

        // Clean up interval when leaving the page
        window.addEventListener('beforeunload', () => {
            clearInterval(updateInterval);
        });

        // Enable start game button if user is the host
        const startGameButton = document.getElementById('startGame');
        if (roomData.roomHost === userId) {
            startGameButton.disabled = false;
            startGameButton.addEventListener('click', async () => {
                try {
                    await startGame(roomId);
                    window.location.href = 'game.html';
                } catch (error) {
                    console.error('Error starting game:', error);
                    alert('Failed to start game. Please try again.');
                }
            });
        }

        // Handle leave room
        document.getElementById('leaveRoom').addEventListener('click', async () => {
            try {
                // Remove user from room
                const userId = localStorage.getItem('connectedUserId');
                const roomId = localStorage.getItem('connectedRoomId');
                const userName = localStorage.getItem('connectedUsername');
                
                await removeUserFromRoom(userId, userName, roomId);

                // Clear room data
                localStorage.removeItem('connectedRoomId');
                localStorage.removeItem('connectedUserId');
                localStorage.removeItem('connectedRoomName');
                localStorage.removeItem('connectedUsername');
                localStorage.removeItem('readyStatus');
                localStorage.removeItem('roomData');
                
                // Redirect to index
                window.location.href = 'load-rooms.html';
            } catch (error) {
                console.error('Error leaving room:', error);
                alert('Failed to leave room. Please try again.');
            }
        });

        // Handle ready up
        document.getElementById('readyUp').addEventListener('click', async () => {
            try {
                const readyButton = document.getElementById('readyUp');
                const newStatus = readyButton.textContent === 'Ready Up' ? '1' : '0';
                await updatePlayerReadyStatus(userId, roomId, newStatus);
                updateRoomData(); // Force update 
                // Toggle button text and class to show ready status
                if (readyButton.textContent === 'Ready Up') {
                    readyButton.textContent = 'Not Ready';
                    readyButton.classList.add('ready');
                } else {
                    readyButton.textContent = 'Ready Up';
                    readyButton.classList.remove('ready');
                }
                // Set local storage to know what ready status this player is
                localStorage.setItem('readyStatus', newStatus);
            } catch (error) {
                console.error('Error updating ready status:', error);
                alert('Failed to update ready status. Please try again.');
            }
        });
    </script>
</body>
</html> 